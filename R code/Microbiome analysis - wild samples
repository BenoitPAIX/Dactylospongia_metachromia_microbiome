ASV_table = read.csv(file = "ASV_table_filtered.csv" , header = TRUE , sep = ";" , row.names = 1)
dim(ASV_table)

TAX_table = read.csv(file = "Taxonomy_table_filtered.csv" , sep = ";" , header = T , row.names = 1)
dim(TAX_table)

META_table = read.csv(file = "Metadata_table_v2.csv" , header = TRUE , sep = ";" , row.names = 1)
dim(META_table)



TAX_table = as.data.frame(TAX_table)
TAX_table

TAX_table.2 <- TAX_table

TAX_table.2$Kingdom <- paste(TAX_table$Kingdom,"|" ,TAX_table$Phylum)
TAX_table.2$Phylum <- paste(tax.Kingdom,"|" ,TAX_table$Phylum)
TAX_table.2$Class <- paste(tax.Phylum,"|" ,TAX_table$Class)
TAX_table.2$Order <- paste(tax.Class,"|" ,TAX_table$Order)
TAX_table.2$Family <- paste(tax.Order,"|" ,TAX_table$Family)
TAX_table.2$Genus <- paste(tax.Family,"|" ,TAX_table$Genus)


#TREE = read_tree("Tree-file.nwk.nhx")
#TREE

# Step 1 : create the phyloseq object directly with the 3 files

ASV_phylo = otu_table(ASV_table, taxa_are_rows = TRUE)
dim(ASV_phylo)

TAX_table.2 = as.matrix(TAX_table.2)
TAX_phylo = tax_table(TAX_table.2)
dim(TAX_phylo)

META_phylo = sample_data(META_table)
dim(META_phylo)

physeq = phyloseq(ASV_phylo, TAX_phylo, META_phylo)
physeq


#rarefaction curves


physeq_subsampled.all = subset_samples(physeq, Study == "Wild"| Site == "Avatoru")
physeq_subsampled.all


data.rarecurve = rarecurve(t(otu_table(physeq_subsampled.all)), step=50,  tidy = TRUE)
data.rarecurve
data.rarecurve$Site



plot.rarecurve = ggplot(data.rarecurve, aes(x = Sample   , y = Species, colour = Site)) 
plot.rarecurve = plot.rarecurve + geom_line(size = 1, alpha = 0.7)
plot.rarecurve = plot.rarecurve + theme_bw(15)
plot.rarecurve = plot.rarecurve + scale_color_manual(values = rep(c("black"),times=52))
plot.rarecurve = plot.rarecurve +  scale_x_continuous(labels = comma_format(big.mark = ".",
                                                                            decimal.mark = ","))
plot.rarecurve = plot.rarecurve + theme(legend.position = "none")
plot.rarecurve = plot.rarecurve + xlab("Sample size (reads number)") + ylab("ASVs number")
plot.rarecurve


# Step 2 : subsamples directly with the subset_samples() function

physeq_subsampled.wild = subset_samples(physeq, Study == "Wild")
physeq_subsampled.wild
